<!DOCTYPE html><html><head><title>为luhu.in启用iptables</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style></style></head><body><div id='preview-contents' class='note-content'>
                        <div id="wmd-preview" class="preview-content"></div>
                    <div id="wmd-preview-section-4204" class="wmd-preview-section preview-content">

<p></p>

</div><div id="wmd-preview-section-4205" class="wmd-preview-section preview-content">

<h2 id="为luhuin启用iptables">为luhu.in启用iptables</h2>

<blockquote>
  <p>经过学习、现使用iptables防火墙的filter进行数据包的过滤。需要提前说明的是：服务器上运行的是Ubuntu 14.04.2 LTS系统。还是一样，第一步先运行起来。</p>
</blockquote>

</div><div id="wmd-preview-section-4206" class="wmd-preview-section preview-content">

<h3 id="更改默认链策略">更改默认链策略</h3>

<blockquote>
  <p>链的默认策略，一般有两种。 <br>
  1.允许所有的包，然后禁止所有有危险的包通过防火墙。</p>
</blockquote>

</div><div id="wmd-preview-section-4207" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs stylus"><span class="hljs-comment line-number">1.</span><span class="hljs-id">#iptables</span> -P INPUT ACCEPT<br><span class="hljs-comment line-number">2.</span><span class="hljs-id">#iptables</span> -P OUTPUT ACCEPT<br><span class="hljs-comment line-number">3.</span><span class="hljs-id">#iptables</span> -P FORWARD ACCEPT<br></code></pre>

<blockquote>
  <p>2.同第一种相反，禁止所有的包，然后根据需要允许特定的包通过防火墙。</p>
</blockquote>

</div><div id="wmd-preview-section-4208" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs sql"><span class="hljs-comment line-number">1.</span>#iptables -P INPUT <span class="hljs-operator"><span class="hljs-keyword">DROP</span><br><span class="hljs-comment line-number">2.</span>#iptables -<span class="hljs-keyword">P</span> <span class="hljs-keyword">OUTPUT</span> <span class="hljs-keyword">DROP</span><br><span class="hljs-comment line-number">3.</span>#iptables -<span class="hljs-keyword">P</span> FORWARD <span class="hljs-keyword">DROP</span></span><br></code></pre>

</div><div id="wmd-preview-section-4209" class="wmd-preview-section preview-content">

<h3 id="永久保存规则">永久保存规则</h3>

</div><div id="wmd-preview-section-4210" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs fortran"><span class="hljs-comment line-number">1.</span>iptables-<span class="hljs-keyword">save</span> &gt;～/iptables<br></code></pre>

</div><div id="wmd-preview-section-4211" class="wmd-preview-section preview-content">

<h3 id="加载iptables规则">加载iptables规则</h3>

</div><div id="wmd-preview-section-4212" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs"><span class="hljs-comment line-number">1.</span>iptables-resotre &lt; ~/iptables  <br></code></pre>

</div><div id="wmd-preview-section-4213" class="wmd-preview-section preview-content">

<h3 id="为luhuin设置iptables防火墙规则">为luhu.in设置iptables防火墙规则</h3>

<blockquote>
  <p>按照比较严谨的规则，luhu.in采用第二种默认策略。即:默认策略为拒绝所有包，然后根据需要明确指定那些数据包可以通过网卡。下面贴出luhu.in的iptables规则。</p>
</blockquote>

</div><div id="wmd-preview-section-4418" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="hljs cpp"><span class="hljs-comment line-number">1.</span><span class="hljs-preprocessor"># Generated by iptables-save v1<span class="hljs-number">.4</span><span class="hljs-number">.21</span> on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br><span class="hljs-comment line-number">2.</span>*mangle<br><span class="hljs-comment line-number">3.</span>:PREROUTING ACCEPT [<span class="hljs-number">38452</span>:<span class="hljs-number">3243137</span>]<br><span class="hljs-comment line-number">4.</span>:INPUT ACCEPT [<span class="hljs-number">38452</span>:<span class="hljs-number">3243137</span>]<br><span class="hljs-comment line-number">5.</span>:FORWARD ACCEPT [<span class="hljs-number">0</span>:<span class="hljs-number">0</span>]<br><span class="hljs-comment line-number">6.</span>:OUTPUT ACCEPT [<span class="hljs-number">32440</span>:<span class="hljs-number">4946907</span>]<br><span class="hljs-comment line-number">7.</span>:POSTROUTING ACCEPT [<span class="hljs-number">22014</span>:<span class="hljs-number">4234956</span>]<br><span class="hljs-comment line-number">8.</span>COMMIT<br><span class="hljs-comment line-number">9.</span><span class="hljs-preprocessor"># Completed on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br><span class="hljs-comment line-number">10.</span><span class="hljs-preprocessor"># Generated by iptables-save v1<span class="hljs-number">.4</span><span class="hljs-number">.21</span> on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br><span class="hljs-comment line-number">11.</span>*nat<br><span class="hljs-comment line-number">12.</span>:PREROUTING ACCEPT [<span class="hljs-number">5990</span>:<span class="hljs-number">310069</span>]<br><span class="hljs-comment line-number">13.</span>:INPUT ACCEPT [<span class="hljs-number">2428</span>:<span class="hljs-number">129801</span>]<br><span class="hljs-comment line-number">14.</span>:OUTPUT ACCEPT [<span class="hljs-number">11218</span>:<span class="hljs-number">745557</span>]<br><span class="hljs-comment line-number">15.</span>:POSTROUTING ACCEPT [<span class="hljs-number">995</span>:<span class="hljs-number">59651</span>]<br><span class="hljs-comment line-number">16.</span>COMMIT<br><span class="hljs-comment line-number">17.</span><span class="hljs-preprocessor"># Completed on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br><span class="hljs-comment line-number">18.</span><span class="hljs-preprocessor"># Generated by iptables-save v1<span class="hljs-number">.4</span><span class="hljs-number">.21</span> on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br><span class="hljs-comment line-number">19.</span>*filter<br><span class="hljs-comment line-number">20.</span><span class="hljs-preprocessor">#更改默认策略，为禁止所有的数据包</span><br><span class="hljs-comment line-number">21.</span>:INPUT DROP [<span class="hljs-number">3263</span>:<span class="hljs-number">168708</span>]<br><span class="hljs-comment line-number">22.</span>:FORWARD DROP [<span class="hljs-number">0</span>:<span class="hljs-number">0</span>]<br><span class="hljs-comment line-number">23.</span>:OUTPUT DROP [<span class="hljs-number">6519</span>:<span class="hljs-number">505220</span>]<br><span class="hljs-comment line-number">24.</span><br><span class="hljs-comment line-number">25.</span><span class="hljs-preprocessor">#允许本地回环</span><br><span class="hljs-comment line-number">26.</span>-A INPUT -s <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -j ACCEPT<br><span class="hljs-comment line-number">27.</span>-A OUTPUT -s <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -j ACCEPT<br><span class="hljs-comment line-number">28.</span><br><span class="hljs-comment line-number">29.</span><span class="hljs-preprocessor">#允许ssh连接</span><br><span class="hljs-comment line-number">30.</span>-A INPUT -p tcp -m tcp --dport <span class="hljs-number">22</span> -j ACCEPT<br><span class="hljs-comment line-number">31.</span>-A OUTPUT -p tcp -m tcp --sport <span class="hljs-number">22</span> -j ACCEPT<br><span class="hljs-comment line-number">32.</span><br><span class="hljs-comment line-number">33.</span><span class="hljs-preprocessor">#允许DNS查询</span><br><span class="hljs-comment line-number">34.</span>-A INPUT -p udp -m udp --sport <span class="hljs-number">53</span> -j ACCEPT<br><span class="hljs-comment line-number">35.</span>-A OUTPUT -p udp -m udp --dport <span class="hljs-number">53</span> -j ACCEPT<br><span class="hljs-comment line-number">36.</span><br><span class="hljs-comment line-number">37.</span><span class="hljs-preprocessor">#允许本机发送http请求</span><br><span class="hljs-comment line-number">38.</span>-A INPUT -p tcp -m tcp --sport <span class="hljs-number">80</span> -j ACCEPT<br><span class="hljs-comment line-number">39.</span>-A OUTPUT -p tcp -m tcp --dport <span class="hljs-number">80</span> -j ACCEPT<br><span class="hljs-comment line-number">40.</span><br><span class="hljs-comment line-number">41.</span><span class="hljs-preprocessor">#允许本机发送https请求</span><br><span class="hljs-comment line-number">42.</span>-A OUTPUT -p tcp -m tcp --dport <span class="hljs-number">443</span> -j ACCEPT<br><span class="hljs-comment line-number">43.</span>-A INPUT -p tcp -m tcp --sport <span class="hljs-number">443</span> -j ACCEPT<br><span class="hljs-comment line-number">44.</span><br><span class="hljs-comment line-number">45.</span><span class="hljs-preprocessor">#允许http连接请求</span><br><span class="hljs-comment line-number">46.</span>-A INPUT -p tcp -m tcp --dport <span class="hljs-number">80</span> -j ACCEPT<br><span class="hljs-comment line-number">47.</span>-A OUTPUT -p tcp -m tcp --sport <span class="hljs-number">80</span> -j ACCEPT<br><span class="hljs-comment line-number">48.</span><br><span class="hljs-comment line-number">49.</span><span class="hljs-preprocessor">#允许https连接</span><br><span class="hljs-comment line-number">50.</span>-A INPUT -p tcp -m tcp --dport <span class="hljs-number">443</span> -j ACCEPT<br><span class="hljs-comment line-number">51.</span>-A OUTPUT -p tcp -m tcp --sport <span class="hljs-number">443</span> -j ACCEPT<br><span class="hljs-comment line-number">52.</span><span class="hljs-preprocessor">#允许来自外部的ping测试</span><br><span class="hljs-comment line-number">53.</span>-A INPUT -p icmp -m icmp --icmp-type <span class="hljs-number">8</span> -j ACCEPT<br><span class="hljs-comment line-number">54.</span>-A OUTPUT -p icmp -m icmp --icmp-type <span class="hljs-number">0</span> -j ACCEPT<br><span class="hljs-comment line-number">55.</span><br><span class="hljs-comment line-number">56.</span><span class="hljs-preprocessor">#允许本机ping外部主机</span><br><span class="hljs-comment line-number">57.</span>-A INPUT -p icmp -m icmp --icmp-type <span class="hljs-number">0</span> -j ACCEPT<br><span class="hljs-comment line-number">58.</span>-A OUTPUT -p icmp -m icmp --icmp-type <span class="hljs-number">8</span> -j ACCEPT<br><span class="hljs-comment line-number">59.</span><br><span class="hljs-comment line-number">60.</span><span class="hljs-preprocessor"># Completed on Thu Jan <span class="hljs-number">28</span> <span class="hljs-number">08</span>:<span class="hljs-number">09</span>:<span class="hljs-number">28</span> <span class="hljs-number">2016</span></span><br></code></pre></div><div id="wmd-preview-section-4275" class="wmd-preview-section preview-content">

<h3 id="references">References:</h3>

<ol><li rel="1"><a href="http://lesca.me/topics/network/iptables" target="_blank">lesca.me iptables系列文章</a></li>
<li rel="2"><a href="http://yijiu.blog.51cto.com/433846/1356254" target="_blank">iptables详解</a></li>
<li rel="3"><a href="http://wiki.ubuntu.org.cn/IptablesHowTo#Configuration_on_startup_.E5.BC.80.E6.9C.BA.E8.87.AA.E5.8A.A8.E5.8A.A0.E8.BD.BD.E9.85.8D.E7.BD.AE" target="_blank">Ubuntu保存iptables防火墙规则的方法</a></li>
</ol></div><div id="wmd-preview-section-footnotes" class="preview-content"></div></div></body></html>