<!DOCTYPE html><html><head><title>PHP实现IP地址访问限制</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style>
.note-content  {font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', STHeiti, 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, Song, sans-serif;}

</style></head><body><div id='preview-contents' class='note-content'>
                        <div id="wmd-preview" class="preview-content"></div>
                    <div id="wmd-preview-section-14" class="wmd-preview-section preview-content">

</div><div id="wmd-preview-section-439" class="wmd-preview-section preview-content">

<h2 id="php实现ip地址访问限制">PHP实现IP地址访问限制</h2>

<blockquote>
  <p>网上也有类似的文章。但都是匹配IP范围、或者是是固定的IP地址。如果访问人群来自广域网，那么客户端的IP有很大几率是ISP分配的动态IP，再用这种匹配方式。就难以做到了。那么该怎么办呢？引入一个概念就可以了–DDNS。<strong>其工作原理为:每次客户端上网之后会得到新的IP地址，之后安装在客户端计算机里的动态域名软件会把这个IP地址发送到动态域名解析服务器，更新域名解析数据库。Internet上的其他人要访问这个域名的时候，动态域名服务器会返回正确的IP地址给他。</strong>这样一来，只要在网站中增加域名白名单即可了。然后通过查询域名得到真实的IP地址即可。好了，下面直接上代码。</p>
</blockquote>

<p>获取客户端IP地址，这个摘录自thinkphp内置函数</p>

</div><div id="wmd-preview-section-515" class="wmd-preview-section preview-content">

<pre class="prettyprint with-line-number hljs-dark"><code class="hljs xquery"><span class="hljs-comment line-number">1.</span><span class="hljs-keyword">function</span> get_client_ip(<span class="hljs-variable">$type</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$adv</span> = <span class="hljs-literal">false</span>)<br><span class="hljs-comment line-number">2.</span>{<br><span class="hljs-comment line-number">3.</span>    <span class="hljs-variable">$type</span> = <span class="hljs-variable">$type</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br><span class="hljs-comment line-number">4.</span>    static <span class="hljs-variable">$ip</span> = null;<br><span class="hljs-comment line-number">5.</span>    if (null !== <span class="hljs-variable">$ip</span>) {<br><span class="hljs-comment line-number">6.</span>        return <span class="hljs-variable">$ip</span>[<span class="hljs-variable">$type</span>];<br><span class="hljs-comment line-number">7.</span>    }<br><span class="hljs-comment line-number">8.</span>    if (<span class="hljs-variable">$adv</span>) {<br><span class="hljs-comment line-number">9.</span>        if (isset($_SERVER[<span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span>])) {<br><span class="hljs-comment line-number">10.</span>            <span class="hljs-variable">$arr</span> = explode(<span class="hljs-string">','</span>, $_SERVER[<span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span>]);<br><span class="hljs-comment line-number">11.</span>            <span class="hljs-variable">$pos</span> = array_search(<span class="hljs-string">'unknown'</span>, <span class="hljs-variable">$arr</span>);<br><span class="hljs-comment line-number">12.</span>            if (false !== <span class="hljs-variable">$pos</span>) {<br><span class="hljs-comment line-number">13.</span>                unset(<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$pos</span>]);<br><span class="hljs-comment line-number">14.</span>            }<br><span class="hljs-comment line-number">15.</span>            <span class="hljs-variable">$ip</span> = trim(<span class="hljs-variable">$arr</span>[<span class="hljs-number">0</span>]);<br><span class="hljs-comment line-number">16.</span>        } elseif (isset($_SERVER[<span class="hljs-string">'HTTP_CLIENT_IP'</span>])) {<br><span class="hljs-comment line-number">17.</span>            <span class="hljs-variable">$ip</span> = $_SERVER[<span class="hljs-string">'HTTP_CLIENT_IP'</span>];<br><span class="hljs-comment line-number">18.</span>        } elseif (isset($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>])) {<br><span class="hljs-comment line-number">19.</span>            <span class="hljs-variable">$ip</span> = $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>];<br><span class="hljs-comment line-number">20.</span>        }<br><span class="hljs-comment line-number">21.</span>    } elseif (isset($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>])) {<br><span class="hljs-comment line-number">22.</span>        <span class="hljs-variable">$ip</span> = $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>];<br><span class="hljs-comment line-number">23.</span>    }<br><span class="hljs-comment line-number">24.</span>    // IP地址合法验证<br><span class="hljs-comment line-number">25.</span>    <span class="hljs-variable">$long</span> = sprintf(<span class="hljs-string">'%u'</span>, ip2long(<span class="hljs-variable">$ip</span>));<br><span class="hljs-comment line-number">26.</span>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$long</span> ? array(<span class="hljs-variable">$ip</span>, <span class="hljs-variable">$long</span>) : array(<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment line-number">27.</span><br><span class="hljs-comment line-number">28.</span>    return <span class="hljs-variable">$ip</span>[<span class="hljs-variable">$type</span>];<br><span class="hljs-comment line-number">29.</span>}<br></code></pre>

<p>域名白名单文件<code>config\htallow.php</code></p>

</div><div id="wmd-preview-section-701" class="wmd-preview-section preview-content">

<pre class="prettyprint with-line-number hljs-dark"><code class="hljs dart"><span class="hljs-comment line-number">1.</span><span class="hljs-keyword">return</span> [<br><span class="hljs-comment line-number">2.</span>    <span class="hljs-string">'allow_hostnames'</span>=&gt;[<br><span class="hljs-comment line-number">3.</span>       <span class="hljs-comment">// 'luhu.wicp.net'</span><br><span class="hljs-comment line-number">4.</span>    ]<br><span class="hljs-comment line-number">5.</span><br><span class="hljs-comment line-number">6.</span>];<br></code></pre>

<p>IP地址访问限制判断</p></div><div id="wmd-preview-section-877" class="wmd-preview-section preview-content">

<pre class="prettyprint with-line-number hljs-dark"><code class="hljs xquery"><span class="hljs-comment line-number">1.</span>// 域名的认证<br><span class="hljs-comment line-number">2.</span><span class="hljs-variable">$ips</span> = <span class="hljs-variable">$this-</span>&gt;get_app_support_ips();<br><span class="hljs-comment line-number">3.</span><span class="hljs-variable">$client</span>_ip = get_client_ip();<br><span class="hljs-comment line-number">4.</span><span class="hljs-keyword">if</span> (in_array(<span class="hljs-variable">$client</span>_ip, <span class="hljs-variable">$ips</span>)) {<br><span class="hljs-comment line-number">5.</span>   // 允许访问什么都不做<br><span class="hljs-comment line-number">6.</span>   return redirect()-&gt;intended();<br><span class="hljs-comment line-number">7.</span>} <span class="hljs-keyword">else</span> {<br><span class="hljs-comment line-number">8.</span>   // 不允许访问<br><span class="hljs-comment line-number">9.</span>   // 退出登陆状态<br><span class="hljs-comment line-number">10.</span>   Auth::logout();<br><span class="hljs-comment line-number">11.</span>   // 返回登陆界面<br><span class="hljs-comment line-number">12.</span>   return redirect()-&gt;back()<br><span class="hljs-comment line-number">13.</span>                        -&gt;withInput()<br><span class="hljs-comment line-number">14.</span>                        -&gt;with(<span class="hljs-string">'message'</span>, trans(<span class="hljs-string">'auth.access_forbidden'</span>));<br><span class="hljs-comment line-number">15.</span>}<br><span class="hljs-comment line-number">16.</span><br><span class="hljs-comment line-number">17.</span>/**<br><span class="hljs-comment line-number">18.</span>     * 根据系统内置的域名白名单获取<br><span class="hljs-comment line-number">19.</span>     * 允许访问的IP列表<br><span class="hljs-comment line-number">20.</span>     *<br><span class="hljs-comment line-number">21.</span>     * @<span class="hljs-keyword">return</span> unknown[]<br><span class="hljs-comment line-number">22.</span>     */<br><span class="hljs-comment line-number">23.</span>    private <span class="hljs-keyword">function</span> get_app_support_ips()<br><span class="hljs-comment line-number">24.</span>    {<br><span class="hljs-comment line-number">25.</span>        <span class="hljs-variable">$host</span>_names = Config::get(<span class="hljs-string">'htallow.allow_hostnames'</span>);<br><span class="hljs-comment line-number">26.</span>        <span class="hljs-variable">$ips</span> = array();<br><span class="hljs-comment line-number">27.</span>        foreach (<span class="hljs-variable">$host</span>_names as <span class="hljs-variable">$hn</span>) {<br><span class="hljs-comment line-number">28.</span>            <span class="hljs-variable">$dns</span> = dns_get_record(<span class="hljs-variable">$hn</span>, DNS_A);<br><span class="hljs-comment line-number">29.</span>            foreach (<span class="hljs-variable">$dns</span> as <span class="hljs-variable">$r</span>) {<br><span class="hljs-comment line-number">30.</span>                <span class="hljs-variable">$ips</span>[] = <span class="hljs-variable">$r</span>[<span class="hljs-string">'ip'</span>];<br><span class="hljs-comment line-number">31.</span>            }<br><span class="hljs-comment line-number">32.</span>        }<br><span class="hljs-comment line-number">33.</span>        return <span class="hljs-variable">$ips</span>;<br><span class="hljs-comment line-number">34.</span>    }<br></code></pre>

<p>动态域名我一直使用的花生壳。刚好自己买的路由上就自带花生壳动态域名的功能。使用起来很方便～。</p></div><div id="wmd-preview-section-footnotes" class="preview-content"></div></div></body></html>